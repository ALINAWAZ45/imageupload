(function(e){function g(n,j){this.form=typeof n=="string"?document.getElementById(n):n;this.options={container:"",selectId:"",accpet:"",previewSize:{width:150,height:150},resize:false,resizeType:"size",size:{width:150,height:150},quality:1,multipart:false,multipartCount:9,beforeUpload:function(){return true},success:function(q){},failure:function(){}};this.imageArray=new Array();this.imageSelected=false;for(var l in j){this.options[l]=j[l]}var i=this.options.container;var o=document.getElementById(this.options.selectId);if(this.options.accept){o.accept=this.options.accept}var p=b=this;var k={fileInput:o,previewSize:p.options.previewSize,resize:p.options.resize,resizeType:p.options.resizeType,size:p.options.size,quality:p.options.quality,imageArray:p.imageArray};var m=/png|jpg|jpeg|gif/i;o.onchange=function(){if(this.value){if(p.options.multipart==true&&p.imageArray.length>=p.options.multipartCount){alert("maximum can only choose "+p.options.multipartCount+" pictures")}else{var r=this.value.substring(this.value.lastIndexOf(".")+1,this.value.length);if(m.test(r)){var q="upload_image";if(p.options.multipart){var s=document.getElementsByClassName("upload-image");q="upload_image"+(s.length+1)}f(k,i,q,function(w,u,t){var v={id:w,name:u,blob:t};if(!p.options.multipart){p.imageArray.splice(0,1)}p.imageArray.push(v);p.imageSelected=true})}else{alert("please choose picture")}}}};this.form.onsubmit=this._ajaxForm.bind(this)}g.prototype={constructor:g,_getXMLHttpRequest:function(){var j;try{j=new XMLHttpRequest()}catch(i){try{j=new ActiveXObject("Msxml2.XMLHTTP")}catch(i){try{j=new ActiveXObject("Microsoft.XMLHTTP")}catch(i){throw new Error("你的浏览器过时了")}}}return j},_ajaxForm:function(){var j=new FormData();var k=a(this.form);k.forEach(function(n,l){var m=n.split("=");j.append(m[0],m[1])});this.imageArray.forEach(function(m,l){j.append(m.name,m.blob)});var i=this._getXMLHttpRequest();i.onreadystatechange=function(){if(i.readyState==0){}else{if(i.readyState==1){}else{if(i.readyState==2){}else{if(i.readyState==3){}else{if(i.readyState==4){if(i.status==200){this.options.success(i.responseText)}else{this.options.failure()}}}}}}}.bind(this);i.open("POST",this.form.action,true);if(this.options.beforeUpload()==false){}else{i.send(j)}return false}};function f(m,j,l,n){var k=m.fileInput.files[0];var i=new FileReader();i.onload=function(){var o=this.result;var p=document.createElement("img");p.name=m.fileInput.id;p.className="upload-image";p.width=m.previewSize.width;p.height=m.previewSize.height;p.src=o;p.onload=function(){c(l,j,p,m.imageArray);var r=m.fileInput;var s=r.value.substring(r.value.lastIndexOf(".")+1);if(m.resize){var q=d(p,s,m);n(l,p.name,q)}else{var q=h(o.split(",")[1],"image/"+s);n(l,p.name,q)}}};i.readAsDataURL(k)}function d(k,o,n){var l=document.createElement("canvas");if(n.resizeType=="size"){l.width=n.size.width;l.height=n.size.height}else{if(n.resizeType=="quality"){var i=k.naturalWidth*n.quality;var m=k.naturalHeight*n.quality;l.width=i;l.height=m}}var j=l.getContext("2d");j.drawImage(k,0,0,l.width,l.height);o=o.toLowerCase();o=o=="jpg"?"jpeg":o;var p=l.toDataURL("image/"+o);return h(p.split(",")[1],"image/"+o)}function h(j,n){var o=e.atob(j);var m=new Uint8Array(o.length);for(var l=0;l<o.length;l++){m[l]=o.charCodeAt(l)}var k=new Blob([m],{type:n});return k}var b;function c(i,k,l,p){var n=document.getElementById(i);if(n!=null&&n.tagName=="DIV"){document.getElementById(k).removeChild(n)}var j=document.createElement("div");j.id=i;j.className="preview";j.style.width=l.width+"px";j.style.height=l.height+"px";var o=document.createElement("div");o.className="preview-option";var m=document.createElement("span");m.className="preview-delete";m.addEventListener("click",function(){var u=this.parentNode.id;document.getElementById(k).removeChild(this.parentNode);var s=false;for(var r=0;r<p.length;r++){if(s&&r>0){p[r].id="upload_image"+(r+1);continue}if(p[r].id==u){p.splice(r,1);s=true;r--}}var t=document.getElementsByClassName("upload-image");if(t.length==0){b.imageSelected=false}var q=[];q.push.apply(q,t);q.forEach(function(w,v){w.parentNode.id="upload_image"+(v+1)})});j.appendChild(l);j.appendChild(o);j.appendChild(m);document.getElementById(k).appendChild(j)}function a(m){var k=m.elements;var j=new Array();for(var l=0;l<k.length;l++){var n=k[l];if(n.type=="radio"||n.type=="checkbox"){if(n.checked){j.push(n.name+"="+n.value)}}else{if(n.type!="submit"&&n.type!="button"&&n.type!="file"){j.push(n.name+"="+n.value)}}}return j}e.ImageUpload=g})(window);